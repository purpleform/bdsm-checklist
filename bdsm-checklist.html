<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>https://purpleform.github.io/bdsm-checklist/bdsm-checklist.html v1.7 (緊湊版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
        }

        .watermark {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            user-select: none;
            z-index: 1;
            overflow: hidden;
        }

        .watermark-text {
            position: absolute;
            font-size: 48px;
            font-weight: bold;
            color: rgba(102, 126, 234, 0.1);
            white-space: nowrap;
            transform: rotate(-45deg);
            letter-spacing: 8px;
        }

        .content {
            position: relative;
            z-index: 2;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
            position: relative;
            z-index: 2;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            font-size: 14px;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .column-left,
        .column-right {
            min-width: 0;
            overflow: hidden;
        }

        .category {
            margin-bottom: 25px;
        }

        .category-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            font-size: 24px;
            font-weight: bold;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            box-sizing: border-box;
            width: 100%;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
            gap: 15px;
        }

        .item:hover {
            background: #f8f9ff;
        }

        .item-name {
            flex: 1;
            font-size: 15px;
            color: #333;
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .rating {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .rating input[type="radio"] {
            display: none;
        }

        .rating label {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid #ddd;
            transition: all 0.2s;
            background: white;
        }

        .rating label:hover {
            transform: scale(1.1);
        }

        /* 緊湊模式樣式 - 用於 PDF 匯出 */
        .compact-mode .item {
            flex-direction: row !important;
            align-items: center !important;
            padding: 8px 10px !important;
            gap: 10px !important;
        }

        .compact-mode .item-name {
            margin-bottom: 0 !important;
            font-size: 14px !important;
        }

        .compact-mode .rating {
            width: auto !important;
            gap: 0 !important;
        }

        .compact-mode .rating label {
            display: none !important;
        }

        .compact-mode .rating input[type="radio"]:checked + label {
            display: inline-flex !important;
            width: auto !important;
            min-width: 32px !important;
            height: 28px !important;
            padding: 0 8px !important;
            font-size: 13px !important;
            font-weight: bold !important;
        }

        .rating input[type="radio"]:checked + label {
            border-width: 3px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* 分数颜色 */
        .rating input[value="4"]:checked + label { background: #4ade80; border-color: #22c55e; color: white; }
        .rating input[value="3"]:checked + label { background: #86efac; border-color: #4ade80; color: white; }
        .rating input[value="2"]:checked + label { background: #bfdbfe; border-color: #60a5fa; color: white; }
        .rating input[value="1"]:checked + label { background: #fde68a; border-color: #fbbf24; color: #333; }
        .rating input[value="0"]:checked + label { background: #fca5a5; border-color: #ef4444; color: white; }
        .rating input[value="-1"]:checked + label { background: #f87171; border-color: #dc2626; color: white; }
        .rating input[value="-2"]:checked + label { background: #dc2626; border-color: #b91c1c; color: white; }
        .rating input[value="-3"]:checked + label { background: #991b1b; border-color: #7f1d1d; color: white; }

        .actions {
            margin-top: 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .action-row {
            display: flex;
            gap: 15px;
            justify-content: center;
            width: 100%;
        }

        button {
            flex: 1 1 0;
            min-width: 0;
            max-width: 200px;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .reset-btn {
            background: #e5e7eb;
            color: #374151;
        }

        .reset-btn:hover {
            background: #d1d5db;
        }

        .footer {
            margin-top: 40px;
            padding: 25px;
            background: #f9fafb;
            border-radius: 10px;
            text-align: center;
            color: #6b7280;
            line-height: 1.8;
            font-size: 14px;
            border: 1px solid #e5e7eb;
            position: relative;
            z-index: 2;
        }

        .footer p {
            margin: 8px 0;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }

        .footer a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        .header-top {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .lang-toggle {
            background: white;
            border: 2px solid white;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #667eea;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .lang-toggle:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* 匯出時隱藏語言切換按鈕 */
        .compact-mode .lang-toggle {
            display: none !important;
        }

        @media (max-width: 1400px) {
            .container {
                padding: 20px;
            }

            .content {
                gap: 20px;
            }

            .item {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px 10px;
            }

            .item-name {
                margin-bottom: 10px;
                font-size: 15px;
                width: 100%;
            }

            .rating {
                width: 100%;
                justify-content: space-between;
            }

            .rating label {
                width: 38px;
                height: 38px;
                font-size: 13px;
            }
        }

        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .container {
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            .item-name {
                font-size: 16px;
            }

            .rating {
                gap: 5px;
            }

            .rating label {
                width: 36px;
                height: 36px;
            }

            .header h1 {
                font-size: 24px;
            }

            .legend {
                font-size: 12px;
                gap: 10px;
            }

            .category-title {
                font-size: 20px;
                padding: 10px 15px;
            }

            .watermark-text {
                font-size: 40px;
                letter-spacing: 10px;
            }
        }

        @media (max-width: 480px) {
            .rating {
                gap: 3px;
            }

            .rating label {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }

            .category-title {
                font-size: 18px;
                padding: 8px 12px;
            }

            .watermark-text {
                font-size: 30px;
                letter-spacing: 5px;
            }
        }

        @media (max-width: 380px) {
            .rating label {
                width: 28px;
                height: 28px;
                font-size: 11px;
            }

            .category-title {
                font-size: 16px;
                padding: 6px 8px;
            }

            .watermark-text {
                font-size: 25px;
                letter-spacing: 3px;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                max-width: 100%;
                box-shadow: none;
                padding: 20px;
            }

            .actions {
                display: none;
            }

            .lang-toggle {
                display: none;
            }

            .watermark {
                display: block !important;
            }

            .watermark-text {
                font-size: 50px;
                letter-spacing: 12px;
                color: rgba(102, 126, 234, 0.08);
            }

            .footer {
                display: block !important;
                margin-top: 20px;
                page-break-inside: avoid;
            }

            .content {
                grid-template-columns: 1fr;
            }

            .category {
                page-break-inside: avoid;
                break-inside: avoid;
                margin-bottom: 20px;
            }

            .item {
                page-break-inside: avoid;
                break-inside: avoid;
                flex-direction: row;
                padding: 8px 5px;
            }

            .item-name {
                font-size: 12px;
                margin-bottom: 0;
            }

            .rating {
                gap: 5px;
                flex-shrink: 0;
            }

            .rating label {
                width: 28px;
                height: 28px;
                font-size: 11px;
                border: 1px solid #999;
            }

            .header {
                margin-bottom: 20px;
            }

            .category-title {
                font-size: 18px;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="watermark" id="watermark-container"></div>
        <div class="header">
            <div class="header-top">
                <h1 data-zh-tw="BDSM項目喜好紫評表 v1.7" data-zh-cn="BDSM项目喜好紫评表 v1.7">BDSM項目喜好紫評表 v1.7</h1>
                <button class="lang-toggle" onclick="toggleLanguage()">简体中文</button>
            </div>
            <div class="legend">
                <div class="legend-item" data-zh-tw="4 - 最喜歡" data-zh-cn="4 - 最喜欢">4 - 最喜歡</div>
                <div class="legend-item" data-zh-tw="3 - 喜歡" data-zh-cn="3 - 喜欢">3 - 喜歡</div>
                <div class="legend-item" data-zh-tw="2 - 接受" data-zh-cn="2 - 接受">2 - 接受</div>
                <div class="legend-item" data-zh-tw="1 - 可以試試" data-zh-cn="1 - 可以试试">1 - 可以試試</div>
                <div class="legend-item" data-zh-tw="0 - 沒試過" data-zh-cn="0 - 没试过">0 - 沒試過</div>
                <div class="legend-item" data-zh-tw="-1 - 軟性界限" data-zh-cn="-1 - 软性界限">-1 - 軟性界限</div>
                <div class="legend-item" data-zh-tw="-2 - 硬性界限" data-zh-cn="-2 - 硬性界限">-2 - 硬性界限</div>
                <div class="legend-item" data-zh-tw="-3 - 極限界限" data-zh-cn="-3 - 极限界限">-3 - 極限界限</div>
            </div>
        </div>

        <div class="content">
            <!-- 左側列 -->
            <div class="column-left">
                <!-- 性愛 -->
                <div class="category">
                    <div class="category-title">性愛</div>
                    <div class="items" id="sex"></div>
                </div>

                <!-- 寵物 -->
                <div class="category">
                    <div class="category-title">寵物</div>
                    <div class="items" id="pet"></div>
                </div>

                <!-- 拘束 -->
                <div class="category">
                    <div class="category-title">拘束</div>
                    <div class="items" id="bondage"></div>
                </div>

                <!-- 生物 -->
                <div class="category">
                    <div class="category-title">生物</div>
                    <div class="items" id="creature"></div>
                </div>

                <!-- 身體改造 -->
                <div class="category">
                    <div class="category-title">身體改造</div>
                    <div class="items" id="body-mod"></div>
                </div>
            </div>

            <!-- 右側列 -->
            <div class="column-right">
                <!-- 性玩具 -->
                <div class="category">
                    <div class="category-title">性玩具</div>
                    <div class="items" id="toys"></div>
                </div>

                <!-- 羞辱 -->
                <div class="category">
                    <div class="category-title">羞辱</div>
                    <div class="items" id="humiliation"></div>
                </div>

                <!-- 刑訊 -->
                <div class="category">
                    <div class="category-title">刑訊</div>
                    <div class="items" id="torture"></div>
                </div>

                <!-- 體液 -->
                <div class="category">
                    <div class="category-title">體液</div>
                    <div class="items" id="fluids"></div>
                </div>

                <!-- 其他 -->
                <div class="category">
                    <div class="category-title">其他</div>
                    <div class="items" id="others"></div>
                </div>
            </div>
        </div>

        <div class="actions">
            <div class="action-row">
                <button class="export-btn" onclick="exportPDF()" data-zh-tw="匯出PDF" data-zh-cn="导出PDF">匯出PDF</button>
                <button class="export-btn" onclick="exportScreenshot()" data-zh-tw="匯出截圖" data-zh-cn="导出截图">匯出截圖</button>
                <button class="reset-btn" onclick="resetAll()" data-zh-tw="重置所有" data-zh-cn="重置所有">重置所有</button>
            </div>
            <div class="action-row">
                <button class="export-btn" onclick="exportJSON()" data-zh-tw="匯出JSON" data-zh-cn="导出JSON">匯出JSON</button>
                <button class="export-btn" onclick="importJSON()" data-zh-tw="匯入JSON" data-zh-cn="导入JSON">匯入JSON</button>
            </div>
        </div>
        <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleJSONFile(event)">

        <div class="footer">
            <p data-zh-tw="此表格由《簡稱樂園》BDSM群內成員合作協力製作而成的不完全項目總匯，刻意避開了一些涉及傷害自己或他人的性偏離項目。" data-zh-cn="此表格由《简称乐园》BDSM群内成员合作协力制作而成的不完全项目总汇，刻意避开了一些涉及伤害自己或他人的性偏离项目。">此表格由《簡稱樂園》BDSM群內成員合作協力製作而成的不完全項目總匯，刻意避開了一些涉及傷害自己或他人的性偏離項目。</p>
            <p data-zh-tw="請勿擦掉浮水印複製貼上修改後另行發布。如果你花錢購買了此物，恭喜你被騙了！" data-zh-cn="请勿擦掉水印复制粘贴修改后另行发布。如果你花钱购买了此物，恭喜你被骗了！">請勿擦掉浮水印複製貼上修改後另行發布。如果你花錢購買了此物，恭喜你被騙了！</p>
            <p data-zh-tw="如果被你從別處看到的，哎喲挺有緣的。" data-zh-cn="如果被你从别处看到的，哎哟挺有缘的。">如果被你從別處看到的，哎喲挺有緣的。</p>
            <p style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                <strong data-zh-tw="貢獻者" data-zh-cn="贡献者">貢獻者</strong><br>
                <span data-zh-tw="BDSM項目搜集：CiCi ｜ 紫評表製作：長風 ｜ 網頁版製作：六六" data-zh-cn="BDSM项目搜集：CiCi ｜ 紫评表制作：长风 ｜ 网页版制作：六六">BDSM項目搜集：CiCi ｜ 紫評表製作：長風 ｜ 網頁版製作：六六</span>
            </p>
            <p><span data-zh-tw="我們的推特" data-zh-cn="我们的推特">我們的推特</span> <a href="https://twitter.com/CF_IS_HERE" target="_blank">@CF_IS_HERE</a></p>
            <p><span data-zh-tw="樂園官網" data-zh-cn="乐园官网">樂園官網</span> <a href="https://leyuan.xyz" target="_blank">https://leyuan.xyz</a></p>
        </div>
    </div>

    <script>
        let currentLang = 'zh-tw';

        // 檢測是否為內置瀏覽器
        function isInAppBrowser() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;

            // 檢測常見的內置瀏覽器
            const inAppBrowsers = [
                'Instagram',
                'FBAN',  // Facebook App
                'FBAV',  // Facebook App
                'Line',
                'Twitter',
                'MicroMessenger',  // WeChat
                'Weibo'
            ];

            return inAppBrowsers.some(browser => ua.includes(browser));
        }

        // 頁面載入時檢查並警告
        function checkBrowserCompatibility() {
            if (isInAppBrowser()) {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
                    color: white;
                    padding: 12px 20px;
                    text-align: center;
                    font-size: 14px;
                    font-weight: bold;
                    z-index: 10000;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    line-height: 1.5;
                `;

                const msg = currentLang === 'zh-tw'
                    ? '⚠️ 偵測到您使用 App 內建瀏覽器<br>匯出功能可能無法正常運作，建議點選右上角「在瀏覽器中開啟」'
                    : '⚠️ 检测到您使用 App 内置浏览器<br>导出功能可能无法正常运作，建议点击右上角「在浏览器中打开」';

                warningDiv.innerHTML = msg;
                document.body.insertBefore(warningDiv, document.body.firstChild);

                // 調整 body padding 避免內容被遮住
                document.body.style.paddingTop = '60px';
            }
        }

        // 生成重複浮水印
        function generateWatermarks() {
            const container = document.getElementById('watermark-container');
            container.innerHTML = '';

            const watermarkText = currentLang === 'zh-tw' ? '簡稱樂園 @CF_IS_HERE' : '简称乐园 @CF_IS_HERE';
            const spacingY = 150; // 垂直間距
            const spacingX = 500; // 水平間距

            // 計算需要多少行和列
            const containerHeight = document.querySelector('.container').scrollHeight;
            const containerWidth = document.querySelector('.container').scrollWidth;

            // 因為旋轉45度，需要更多的覆蓋範圍
            const rows = Math.ceil(containerHeight / spacingY) + 6;
            const cols = Math.ceil(containerWidth / spacingX) + 6;

            for (let row = -3; row < rows; row++) {
                for (let col = -3; col < cols; col++) {
                    const span = document.createElement('span');
                    span.className = 'watermark-text';
                    span.textContent = watermarkText;

                    // 交錯排列：奇數行向右偏移半個間距
                    const offsetX = (row % 2 === 0) ? 0 : spacingX / 2;

                    span.style.top = (row * spacingY) + 'px';
                    span.style.left = (col * spacingX + offsetX) + 'px';
                    container.appendChild(span);
                }
            }
        }

        const items = {
            'zh-tw': {
                sex: [
                '用手幫主人自慰', '口爆', '口交', '吞精', '顏射', '肛交',
                '陰道內射', '肛門內射', '潮吹失禁', '情趣用品折磨',
                '強制連續高潮', '公共場所做愛', '主人面前侍奉其他人',
                '主人不在時侍奉其他人', '強姦', '輪姦', '多處被插入',
                '同性多人性行為', '異性多人性行為', '4P以上', '多奴/多主侍奉',
                '第四愛', '亂倫'
            ],
            pet: [
                '摸頭', '戀物', '尾巴穿戴', '爬行', '項圈', '餵食',
                '叼食物', '聞氣味', '學叫聲', '踩踏', '戶外暴露',
                '戶外調教', '戶外裸體', '戶外流放', '騎乘', '囚籠關押',
                '圈養'
            ],
            bondage: [
                '剝奪聽覺', '剝奪視覺', '禁言', '禁慾', '高潮後強制刺激',
                '繩藝', '拘束衣', '色情性拒絕（TD）', '貞操帶', '思維控制',
                '憋尿', '空吊/倒掛', '強制排泄', '監禁（多日）'
            ],
            creature: [
                '觸手/外星人（Cosplay）', '生物塞入', '獸交', '群獸輪交',
                '人獸同交', '昆蟲爬身'
            ],
            'body-mod': [
                '陰道擴張', '尿道擴張', '肛門擴張', '刺青', '催乳', '尿道刺激',
                '穿刺', '穿環', '疤痕', '烙印', '拳交', '藥物（激素）'
            ],
            toys: [
                '角色扮演', '制服誘惑', '挑選/訓練奴隸', '模特/人偶裝扮',
                '作為女僕（伺候）', '作為家居', '放置', '租賃/交易'
            ],
            humiliation: [
                '遠端指令', '不穿內衣', '羞恥視頻照片拍攝', '窺陰癖',
                '剃毛', '舔足', '視覺性騷擾', '言語管教',
                '言語羞辱（自身）', '淫妻/淫夫癖', '自慰展示', '女體盛',
                '內視鏡研究', '分享羞恥視頻照片', '出軌綠帽', '異性裝',
                '網絡公調', '露出（朋友）', '露出（生人）', '公共場所暴露',
                '公共場所調教', '公開場合項圈', '公開場合捆綁（衣內）',
                '公開場合器具（衣內）', '言語羞辱（親人）'
            ],
            torture: [
                '搔癢', '輕咬', '打屁股', '身上寫字', '滴蠟',
                '打耳光', '拉扯頭髮', '鞭子', '板拍', '鼻勾',
                '走繩', '冰刑', '坐臉', '舔肛', '虐乳',
                '體罰', '水刑', '火刑', '三角木馬', '灌腸',
                '虐陰/陽', '異物塗抹', '異物灌/塞入（陰道）', '異物灌/塞入（膀胱）',
                '異物灌/塞入（肛門）', '皮膚磨損', '踢踹', '性窒息',
                '電擊'
            ],
            fluids: [
                '唾液', '汗水', '飲尿', '飲經血', '尿浴', '糞浴',
                '食糞'
            ],
            others: [
                '多主/奴調教', 'ATM', '紫評表'
            ]
                },
            'zh-cn': {
                sex: [
                '用手帮主人自慰', '口爆', '口交', '吞精', '颜射', '肛交',
                '阴道内射', '肛门内射', '潮吹失禁', '情趣用品折磨',
                '强制连续高潮', '公共场所做爱', '主人面前侍奉其他人',
                '主人不在时侍奉其他人', '强奸', '轮奸', '多处被插入',
                '同性多人性行为', '异性多人性行为', '4P以上', '多奴/多主侍奉',
                '第四爱', '乱伦'
            ],
            pet: [
                '摸头', '恋物', '尾巴穿戴', '爬行', '项圈', '喂食',
                '叼食物', '闻气味', '学叫声', '踩踏', '户外暴露',
                '户外调教', '户外裸体', '户外流放', '骑乘', '囚笼关押',
                '圈养'
            ],
            bondage: [
                '剥夺听觉', '剥夺视觉', '禁言', '禁欲', '高潮后强制刺激',
                '绳艺', '拘束衣', '色情性拒绝（TD）', '贞操带', '思维控制',
                '憋尿', '空吊/倒挂', '强制排泄', '监禁（多日）'
            ],
            creature: [
                '触手/外星人（Cosplay）', '生物塞入', '兽交', '群兽轮交',
                '人兽同交', '昆虫爬身'
            ],
            'body-mod': [
                '阴道扩张', '尿道扩张', '肛门扩张', '刺青', '催乳', '尿道刺激',
                '穿刺', '穿环', '疤痕', '烙印', '拳交', '药物（激素）'
            ],
            toys: [
                '角色扮演', '制服诱惑', '挑选/训练奴隶', '模特/人偶装扮',
                '作为女仆（伺候）', '作为家居', '放置', '租赁/交易'
            ],
            humiliation: [
                '远端指令', '不穿内衣', '羞耻视频照片拍摄', '窥阴癖',
                '剃毛', '舔足', '视觉性骚扰', '言语管教',
                '言语羞辱（自身）', '淫妻/淫夫癖', '自慰展示', '女体盛',
                '内视镜研究', '分享羞耻视频照片', '出轨绿帽', '异性装',
                '网络公调', '露出（朋友）', '露出（生人）', '公共场所暴露',
                '公共场所调教', '公开场合项圈', '公开场合捆绑（衣内）',
                '公开场合器具（衣内）', '言语羞辱（亲人）'
            ],
            torture: [
                '搔痒', '轻咬', '打屁股', '身上写字', '滴蜡',
                '打耳光', '拉扯头发', '鞭子', '板拍', '鼻钩',
                '走绳', '冰刑', '坐脸', '舔肛', '虐乳',
                '体罚', '水刑', '火刑', '三角木马', '灌肠',
                '虐阴/阳', '异物涂抹', '异物灌/塞入（阴道）', '异物灌/塞入（膀胱）',
                '异物灌/塞入（肛门）', '皮肤磨损', '踢踹', '性窒息',
                '电击'
            ],
            fluids: [
                '唾液', '汗水', '饮尿', '饮经血', '尿浴', '粪浴',
                '食粪'
            ],
            others: [
                '多主/奴调教', 'ATM', '紫评表'
            ]
            }
        };

        const categoryNames = {
            'zh-tw': {
                sex: '性愛',
                pet: '寵物',
                bondage: '拘束',
                creature: '生物',
                'body-mod': '身體改造',
                toys: '性玩具',
                humiliation: '羞辱',
                torture: '刑訊',
                fluids: '體液',
                others: '其他'
            },
            'zh-cn': {
                sex: '性爱',
                pet: '宠物',
                bondage: '拘束',
                creature: '生物',
                'body-mod': '身体改造',
                toys: '性玩具',
                humiliation: '羞辱',
                torture: '刑讯',
                fluids: '体液',
                others: '其他'
            }
        };

        function createRatingButtons(categoryId, itemName, index) {
            const ratings = [4, 3, 2, 1, 0, -1, -2, -3];
            let html = '<div class="rating">';
            ratings.forEach(rating => {
                const id = `${categoryId}-${index}-${rating}`;
                html += `
                    <input type="radio" name="${categoryId}-${index}" value="${rating}" id="${id}">
                    <label for="${id}">${rating}</label>
                `;
            });
            html += '</div>';
            return html;
        }

        function initializeItems() {
            const currentItems = items[currentLang];
            Object.keys(currentItems).forEach(categoryId => {
                const container = document.getElementById(categoryId);
                if (container) {
                    container.innerHTML = ''; // 清空現有內容
                    currentItems[categoryId].forEach((itemName, index) => {
                        const itemHtml = `
                            <div class="item">
                                <div class="item-name">${itemName}</div>
                                ${createRatingButtons(categoryId, itemName, index)}
                            </div>
                        `;
                        container.innerHTML += itemHtml;
                    });
                }
            });

            // 更新分類標題
            Object.keys(categoryNames[currentLang]).forEach(categoryId => {
                const titleElement = document.querySelector(`#${categoryId}`).previousElementSibling;
                if (titleElement && titleElement.classList.contains('category-title')) {
                    titleElement.textContent = categoryNames[currentLang][categoryId];
                }
            });
        }

        function toggleLanguage() {
            const langButton = document.querySelector('.lang-toggle');

            if (currentLang === 'zh-tw') {
                currentLang = 'zh-cn';
                langButton.textContent = '繁體中文';
            } else {
                currentLang = 'zh-tw';
                langButton.textContent = '简体中文';
            }

            // 更新所有帶有語言屬性的元素
            document.querySelectorAll('[data-zh-tw]').forEach(element => {
                element.textContent = element.getAttribute(`data-${currentLang}`);
            });

            // 重新載入項目
            initializeItems();

            // 重新生成浮水印
            generateWatermarks();
        }

        async function exportPDF() {
            // 檢查是否所有項目都已填寫
            const allItems = document.querySelectorAll('.item');
            const unfilledItems = [];

            allItems.forEach(item => {
                const itemName = item.querySelector('.item-name').textContent.trim();
                const radios = item.querySelectorAll('input[type="radio"]');
                const isChecked = Array.from(radios).some(radio => radio.checked);

                if (!isChecked) {
                    unfilledItems.push(itemName);
                }
            });

            // 如果有未填寫的項目，詢問使用者是否繼續
            if (unfilledItems.length > 0) {
                const confirmMsg = currentLang === 'zh-tw'
                    ? `還有 ${unfilledItems.length} 個項目未填寫，是否繼續匯出？\n\n未填寫的項目將不會顯示在緊湊版 PDF 中。`
                    : `还有 ${unfilledItems.length} 个项目未填写，是否继续导出？\n\n未填写的项目将不会显示在紧凑版 PDF 中。`;

                if (!confirm(confirmMsg)) {
                    return; // 使用者選擇取消
                }
            }

            const container = document.querySelector('.container');
            const actionsDiv = document.querySelector('.actions');
            const langToggle = document.querySelector('.lang-toggle');

            // 暫時隱藏按鈕
            actionsDiv.style.display = 'none';
            langToggle.style.display = 'none';

            // 保存原始樣式
            const contentDiv = document.querySelector('.content');
            const originalStyles = {
                bodyOverflow: document.body.style.overflow,
                containerWidth: container.style.width,
                containerMaxWidth: container.style.maxWidth,
                containerHeight: container.style.height,
                containerMaxHeight: container.style.maxHeight,
                containerPadding: container.style.padding,
                contentGap: contentDiv.style.gap
            };

            try {
                document.body.style.overflow = 'visible';
                container.style.height = 'auto';
                container.style.maxHeight = 'none';

                // 啟用緊湊模式 - 只顯示已選的分數
                container.classList.add('compact-mode');

                // 先用 A4 寬度試算（並強制兩欄）
                const a4WidthPx = 794;
                container.style.width = a4WidthPx + 'px';
                container.style.maxWidth = a4WidthPx + 'px';
                container.style.padding = '30px 20px';

                // 強制兩欄布局（確保 Grid 生效）
                contentDiv.style.display = 'grid';
                contentDiv.style.gridTemplateColumns = '1fr 1fr';
                contentDiv.style.gap = '20px';

                await new Promise(resolve => setTimeout(resolve, 200));

                let actualHeight = Math.max(
                    container.scrollHeight,
                    container.offsetHeight,
                    container.clientHeight
                );

                // 計算 A4 寬度時的 PDF 高度
                const a4PdfHeight = (actualHeight * 210) / a4WidthPx;

                console.log('試算 A4 寬度 PDF 高度:', a4PdfHeight.toFixed(2), 'mm');

                let targetWidth = a4WidthPx;

                // 如果超過 14400mm 限制，改用原始寬度
                if (a4PdfHeight > 14400) {
                    console.log('超過限制，改用原始寬度');

                    // 恢復原始寬度和樣式
                    container.style.width = originalStyles.containerWidth;
                    container.style.maxWidth = originalStyles.containerMaxWidth;
                    container.style.padding = originalStyles.containerPadding;
                    contentDiv.style.display = '';
                    contentDiv.style.gridTemplateColumns = '';
                    contentDiv.style.gap = originalStyles.contentGap;

                    await new Promise(resolve => setTimeout(resolve, 200));

                    actualHeight = Math.max(
                        container.scrollHeight,
                        container.offsetHeight,
                        container.clientHeight
                    );

                    targetWidth = container.scrollWidth;
                    console.log('使用原始寬度:', targetWidth, 'px');
                }

                console.log('最終 Container 尺寸:', targetWidth, 'x', actualHeight, 'px');

                const canvas = await html2canvas(container, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    windowHeight: actualHeight,
                    height: actualHeight,
                    width: targetWidth,
                    scrollY: -window.scrollY,
                    scrollX: -window.scrollX
                });

                console.log('Canvas size:', canvas.width, 'x', canvas.height);

                const { jsPDF } = window.jspdf;
                const imgData = canvas.toDataURL('image/png', 1.0);

                // 計算PDF尺寸
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const pdfWidth = 210;
                const ratio = pdfWidth / imgWidth;
                const pdfHeight = imgHeight * ratio;

                console.log('最終 PDF 尺寸:', pdfWidth, 'x', pdfHeight.toFixed(2), 'mm');

                // 創建自定義尺寸的PDF
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [pdfWidth, pdfHeight]
                });

                // 將整張圖片放入PDF
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

                const filename = currentLang === 'zh-tw' ? 'BDSM項目喜好紫評表.pdf' : 'BDSM项目喜好紫评表.pdf';
                const pdfBlob = pdf.output('blob');

                // 優先使用 Web Share API
                if (navigator.share && navigator.canShare) {
                    try {
                        const file = new File([pdfBlob], filename, { type: 'application/pdf' });

                        if (navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                files: [file],
                                title: currentLang === 'zh-tw' ? 'BDSM 紫評表' : 'BDSM 紫评表'
                            });
                            console.log('PDF shared successfully');
                            return;
                        }
                    } catch (error) {
                        console.log('Web Share API failed, fallback to download:', error);
                        // 如果使用者取消分享，不顯示錯誤，直接降級到下載
                        if (error.name === 'AbortError') {
                            return;
                        }
                    }
                }

                // 降級方案：檢查是否為內置瀏覽器
                if (isInAppBrowser()) {
                    const inAppMsg = currentLang === 'zh-tw'
                        ? '⚠️ App 內建瀏覽器不支援下載功能\n\n請點選右上角「⋯」或「分享」按鈕\n選擇「在 Safari 中開啟」或「在瀏覽器中開啟」\n\n然後重新匯出 PDF 即可下載。'
                        : '⚠️ App 内置浏览器不支持下载功能\n\n请点击右上角「⋯」或「分享」按钮\n选择「在 Safari 中打开」或「在浏览器中打开」\n\n然后重新导出 PDF 即可下载。';
                    alert(inAppMsg);
                    return;
                }

                // 傳統下載
                const blobUrl = URL.createObjectURL(pdfBlob);
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                setTimeout(() => {
                    URL.revokeObjectURL(blobUrl);
                }, 100);

                console.log('PDF export completed');
            } catch (error) {
                console.error('PDF導出失敗:', error);
                const errorMsg = currentLang === 'zh-tw' ? 'PDF導出失敗，請重試' : 'PDF导出失败，请重试';
                alert(errorMsg);
            } finally {
                // 移除緊湊模式
                container.classList.remove('compact-mode');

                // 恢復所有原始樣式
                document.body.style.overflow = originalStyles.bodyOverflow;
                container.style.width = originalStyles.containerWidth;
                container.style.maxWidth = originalStyles.containerMaxWidth;
                container.style.height = originalStyles.containerHeight;
                container.style.maxHeight = originalStyles.containerMaxHeight;
                container.style.padding = originalStyles.containerPadding;
                contentDiv.style.display = '';
                contentDiv.style.gridTemplateColumns = '';
                contentDiv.style.gap = originalStyles.contentGap;
                actionsDiv.style.display = '';
                langToggle.style.display = 'block';

                // 強制瀏覽器重新渲染，確保 compact-mode 的樣式完全移除
                void container.offsetHeight;
            }
        }

        async function exportScreenshot() {
            // 檢查是否所有項目都已填寫
            const allItems = document.querySelectorAll('.item');
            const unfilledItems = [];

            allItems.forEach(item => {
                const itemName = item.querySelector('.item-name').textContent.trim();
                const radios = item.querySelectorAll('input[type="radio"]');
                const isChecked = Array.from(radios).some(radio => radio.checked);

                if (!isChecked) {
                    unfilledItems.push(itemName);
                }
            });

            // 如果有未填寫的項目，詢問使用者是否繼續
            if (unfilledItems.length > 0) {
                const confirmMsg = currentLang === 'zh-tw'
                    ? `還有 ${unfilledItems.length} 個項目未填寫，是否繼續匯出？\n\n未填寫的項目將不會顯示在緊湊版 PNG 中。`
                    : `还有 ${unfilledItems.length} 个项目未填写，是否继续导出？\n\n未填写的项目将不会显示在紧凑版 PNG 中。`;

                if (!confirm(confirmMsg)) {
                    return; // 使用者選擇取消
                }
            }

            const container = document.querySelector('.container');
            const actionsDiv = document.querySelector('.actions');
            const langToggle = document.querySelector('.lang-toggle');
            const contentDiv = document.querySelector('.content');

            // 保存原始樣式
            const originalStyles = {
                bodyOverflow: document.body.style.overflow,
                containerWidth: container.style.width,
                containerMaxWidth: container.style.maxWidth,
                containerHeight: container.style.height,
                containerMaxHeight: container.style.maxHeight,
                containerPadding: container.style.padding,
                contentGap: contentDiv.style.gap
            };

            try {
                // 隱藏按鈕
                actionsDiv.style.display = 'none';
                langToggle.style.display = 'none';

                // 啟用緊湊模式
                container.classList.add('compact-mode');

                document.body.style.overflow = 'visible';
                container.style.height = 'auto';
                container.style.maxHeight = 'none';

                // 使用 A4 寬度以獲得更緊湊的佈局
                const a4WidthPx = 794;
                container.style.width = a4WidthPx + 'px';
                container.style.maxWidth = a4WidthPx + 'px';
                container.style.padding = '30px 20px';

                // 強制兩欄 Grid 佈局
                contentDiv.style.display = 'grid';
                contentDiv.style.gridTemplateColumns = '1fr 1fr';
                contentDiv.style.gap = '20px';

                // 等待瀏覽器重新渲染
                await new Promise(resolve => setTimeout(resolve, 200));

                const actualHeight = Math.max(
                    container.scrollHeight,
                    container.offsetHeight,
                    container.clientHeight
                );

                console.log('PNG 匯出 (緊湊模式) - Container height:', actualHeight);

                const canvas = await html2canvas(container, {
                    scale: 3,  // 使用更高的解析度
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    windowHeight: actualHeight,
                    height: actualHeight,
                    width: a4WidthPx,
                    scrollY: -window.scrollY,
                    scrollX: -window.scrollX
                });

                console.log('PNG Canvas size:', canvas.width, 'x', canvas.height);

                // 將 canvas 轉換為圖片並下載
                canvas.toBlob(async (blob) => {
                    const filename = currentLang === 'zh-tw' ? 'BDSM喜好紫評表.png' : 'BDSM喜好紫评表.png';

                    // 優先使用 Web Share API
                    if (navigator.share && navigator.canShare) {
                        try {
                            const file = new File([blob], filename, { type: 'image/png' });

                            if (navigator.canShare({ files: [file] })) {
                                await navigator.share({
                                    files: [file],
                                    title: currentLang === 'zh-tw' ? 'BDSM 紫評表' : 'BDSM 紫评表'
                                });
                                console.log('PNG shared successfully');
                                return;
                            }
                        } catch (error) {
                            console.log('Web Share API failed, fallback to download:', error);
                            // 如果使用者取消分享，不顯示錯誤
                            if (error.name === 'AbortError') {
                                return;
                            }
                        }
                    }

                    // 降級方案：檢查是否為內置瀏覽器
                    if (isInAppBrowser()) {
                        const inAppMsg = currentLang === 'zh-tw'
                            ? '⚠️ App 內建瀏覽器不支援下載功能\n\n請點選右上角「⋯」或「分享」按鈕\n選擇「在 Safari 中開啟」或「在瀏覽器中開啟」\n\n然後重新匯出截圖即可下載。'
                            : '⚠️ App 内置浏览器不支持下载功能\n\n请点击右上角「⋯」或「分享」按钮\n选择「在 Safari 中打开」或「在浏览器中打开」\n\n然后重新导出截图即可下载。';
                        alert(inAppMsg);
                        return;
                    }

                    // 傳統下載
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 100);
                }, 'image/png', 1.0);

                console.log('PNG export completed');
            } catch (error) {
                console.error('截圖失敗:', error);
                const errorMsg = currentLang === 'zh-tw' ? '截圖失敗，請重試' : '截图失败，请重试';
                alert(errorMsg);
            } finally {
                // 移除緊湊模式
                container.classList.remove('compact-mode');

                // 恢復所有原始樣式
                document.body.style.overflow = originalStyles.bodyOverflow;
                container.style.width = originalStyles.containerWidth;
                container.style.maxWidth = originalStyles.containerMaxWidth;
                container.style.height = originalStyles.containerHeight;
                container.style.maxHeight = originalStyles.containerMaxHeight;
                container.style.padding = originalStyles.containerPadding;
                contentDiv.style.display = '';
                contentDiv.style.gridTemplateColumns = '';
                contentDiv.style.gap = originalStyles.contentGap;
                actionsDiv.style.display = '';
                langToggle.style.display = 'block';

                // 強制瀏覽器重新渲染，確保 compact-mode 的樣式完全移除
                void container.offsetHeight;
            }
        }

        async function exportJSON() {
            const ratings = {};
            const currentItems = items[currentLang];

            // 遍歷所有分類
            Object.keys(currentItems).forEach(categoryId => {
                const categoryRatings = [];
                const itemCount = currentItems[categoryId].length;

                // 遍歷該分類的所有項目
                for (let i = 0; i < itemCount; i++) {
                    const radios = document.querySelectorAll(`input[name="${categoryId}-${i}"]`);
                    let selectedValue = null;

                    radios.forEach(radio => {
                        if (radio.checked) {
                            selectedValue = parseInt(radio.value);
                        }
                    });

                    categoryRatings.push(selectedValue);
                }

                ratings[categoryId] = categoryRatings;
            });

            // 建立 JSON 資料
            const jsonData = {
                version: "1.7",
                language: currentLang,
                exportDate: new Date().toISOString(),
                ratings: ratings
            };

            // 下載 JSON 檔案（優先使用 Web Share API）
            const jsonString = JSON.stringify(jsonData, null, 2);
            const filename = currentLang === 'zh-tw' ? 'BDSM紫評表資料.json' : 'BDSM紫评表数据.json';
            const blob = new Blob([jsonString], { type: 'application/json' });

            // 優先使用 Web Share API
            if (navigator.share && navigator.canShare) {
                try {
                    const file = new File([blob], filename, { type: 'application/json' });

                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            files: [file],
                            title: currentLang === 'zh-tw' ? 'BDSM 紫評表資料' : 'BDSM 紫评表数据'
                        });
                        console.log('JSON shared successfully');
                        return;
                    }
                } catch (error) {
                    console.log('Web Share API failed, fallback to download:', error);
                    // 如果使用者取消分享，不顯示錯誤
                    if (error.name === 'AbortError') {
                        return;
                    }
                }
            }

            // 降級方案：檢查是否為內置瀏覽器
            if (isInAppBrowser()) {
                const inAppMsg = currentLang === 'zh-tw'
                    ? '⚠️ App 內建瀏覽器不支援下載功能\n\n建議：\n1. 點選右上角「在 Safari 中開啟」\n2. 或點選「確定」複製 JSON 內容備份'
                    : '⚠️ App 内置浏览器不支持下载功能\n\n建议：\n1. 点击右上角「在 Safari 中打开」\n2. 或点击「确定」复制 JSON 内容备份';

                if (confirm(inAppMsg)) {
                    showJSONContent(jsonString);
                }
                return;
            }

            // 傳統下載
            try {
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                setTimeout(() => {
                    URL.revokeObjectURL(url);
                    const successMsg = currentLang === 'zh-tw' ? 'JSON 資料已匯出！' : 'JSON 数据已导出！';
                    alert(successMsg);
                }, 100);
            } catch (error) {
                // 下載失敗時顯示內容
                console.error('下載失敗:', error);
                const fallbackMsg = currentLang === 'zh-tw'
                    ? '無法自動下載，將顯示 JSON 內容供您複製保存。'
                    : '无法自动下载，将显示 JSON 内容供您复制保存。';
                alert(fallbackMsg);
                showJSONContent(jsonString);
            }
        }

        // 顯示 JSON 內容的輔助函數
        function showJSONContent(jsonString) {
            const textarea = document.createElement('textarea');
            textarea.value = jsonString;
            textarea.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:80%;height:60%;z-index:9999;padding:20px;font-family:monospace;font-size:12px;border:2px solid #667eea;border-radius:8px;';
            document.body.appendChild(textarea);
            textarea.select();

            const copyMsg = currentLang === 'zh-tw'
                ? '請複製以下內容保存。\n\n提示：可用分享功能傳到備忘錄或雲端。'
                : '请复制以下内容保存。\n\n提示：可用分享功能传到备忘录或云端。';

            if (confirm(copyMsg + '\n\n' + (currentLang === 'zh-tw' ? '點擊確定自動複製到剪貼簿' : '点击确定自动复制到剪贴板'))) {
                try {
                    document.execCommand('copy');
                    alert(currentLang === 'zh-tw' ? '已複製到剪貼簿！' : '已复制到剪贴板！');
                } catch (e) {
                    alert(currentLang === 'zh-tw' ? '請手動選取並複製內容' : '请手动选取并复制内容');
                }
            }

            setTimeout(() => {
                if (document.body.contains(textarea)) {
                    document.body.removeChild(textarea);
                }
            }, 30000); // 30秒後自動移除
        }

        function importJSON() {
            // 觸發隱藏的檔案選擇器
            document.getElementById('jsonFileInput').click();
        }

        function handleJSONFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);

                    // 檢查版本
                    if (!jsonData.version || jsonData.version !== "1.7") {
                        const versionWarning = currentLang === 'zh-tw'
                            ? `警告：此 JSON 檔案的版本 (${jsonData.version || '未知'}) 可能與目前版本 (1.7) 不相容。\n\n是否繼續匯入？`
                            : `警告：此 JSON 文件的版本 (${jsonData.version || '未知'}) 可能与当前版本 (1.7) 不兼容。\n\n是否继续导入？`;

                        if (!confirm(versionWarning)) {
                            event.target.value = ''; // 清空檔案選擇
                            return;
                        }
                    }

                    // 檢查資料格式
                    if (!jsonData.ratings) {
                        throw new Error('Invalid JSON format: missing ratings data');
                    }

                    const currentItems = items[currentLang];
                    let incompatibleCategories = [];

                    // 檢查陣列長度是否相容
                    Object.keys(jsonData.ratings).forEach(categoryId => {
                        if (currentItems[categoryId]) {
                            const expectedLength = currentItems[categoryId].length;
                            const actualLength = jsonData.ratings[categoryId].length;

                            if (expectedLength !== actualLength) {
                                incompatibleCategories.push(
                                    `${categoryId}: ${currentLang === 'zh-tw' ? '預期' : '预期'} ${expectedLength} ${currentLang === 'zh-tw' ? '項，實際' : '项，实际'} ${actualLength} ${currentLang === 'zh-tw' ? '項' : '项'}`
                                );
                            }
                        }
                    });

                    if (incompatibleCategories.length > 0) {
                        const incompatibleMsg = currentLang === 'zh-tw'
                            ? `警告：以下分類的項目數量不相容：\n\n${incompatibleCategories.join('\n')}\n\n這可能會導致評分對應錯誤。是否繼續匯入？`
                            : `警告：以下分类的项目数量不兼容：\n\n${incompatibleCategories.join('\n')}\n\n这可能会导致评分对应错误。是否继续导入？`;

                        if (!confirm(incompatibleMsg)) {
                            event.target.value = '';
                            return;
                        }
                    }

                    // 匯入資料
                    let importedCount = 0;
                    Object.keys(jsonData.ratings).forEach(categoryId => {
                        if (currentItems[categoryId]) {
                            const categoryRatings = jsonData.ratings[categoryId];

                            categoryRatings.forEach((rating, index) => {
                                if (rating !== null && index < currentItems[categoryId].length) {
                                    const radio = document.querySelector(`input[name="${categoryId}-${index}"][value="${rating}"]`);
                                    if (radio) {
                                        radio.checked = true;
                                        importedCount++;
                                    }
                                }
                            });
                        }
                    });

                    const successMsg = currentLang === 'zh-tw'
                        ? `成功匯入 ${importedCount} 個評分！`
                        : `成功导入 ${importedCount} 个评分！`;
                    alert(successMsg);

                } catch (error) {
                    console.error('JSON 匯入錯誤:', error);
                    const errorMsg = currentLang === 'zh-tw'
                        ? `JSON 匯入失敗：${error.message}`
                        : `JSON 导入失败：${error.message}`;
                    alert(errorMsg);
                }

                // 清空檔案選擇，允許重複匯入同一檔案
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        function resetAll() {
            const confirmMsg = currentLang === 'zh-tw' ? '確定要重置所有評分嗎？' : '确定要重置所有评分吗？';
            if (confirm(confirmMsg)) {
                document.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.checked = false;
                });
            }
        }

        // 頁面載入時初始化
        window.addEventListener('DOMContentLoaded', function() {
            checkBrowserCompatibility();  // 檢查瀏覽器相容性
            initializeItems();
            generateWatermarks();
        });

        // 窗口大小改變時重新生成浮水印
        window.addEventListener('resize', generateWatermarks);
    </script>
</body>
</html>
